version: 2

models:
  - name: customers
    description: >
      Customer-level dimension table. One row per customer with
      aggregated order counts, revenue totals, lifecycle dates,
      user attributes. Built from the orders mart with user
      dimensions from staging and country names from seed_countries.
    config:
      meta:
        metrics:
          revenue_per_customer:
            type: number
            label: "Revenue per Customer (USD)"
            description: >
              Average revenue across all customers.
            sql: >
              ${sum_total_revenue_usd}
              / nullif(${customer_count}, 0)
            format: '[$]#,##0.00'
            groups:
              - "Revenue"
          avg_orders_per_customer:
            type: number
            label: "Avg Orders per Customer"
            description: >
              Average total orders across all customers.
            sql: >
              ${sum_total_orders}
              / nullif(${customer_count}, 0)
            format: '#,##0.0'
            groups:
              - "Orders"
          repeat_purchaser_rate:
            type: number
            label: "Repeat Purchaser Rate"
            description: >
              Proportion of customers who purchased more than once.
            sql: >
              ${repeat_purchasers}
              / nullif(${customer_count}, 0)
            format: '0.0%'
            groups:
              - "Rates"
    columns:
      - name: user_id
        description: >
          Unique customer identifier (UUID, cast to string).
        tests:
          - unique
          - not_null
        config:
          meta:
            dimension:
              groups:
                - "IDs"
            metrics:
              customer_count:
                type: count
                label: "Total Customers"
                description: "Count of all customers."
                groups:
                  - "Customers"

      - name: platform
        description: >
          Platform the customer signed up on (lowercase).
          Static attribute captured at registration.
        config:
          meta:
            dimension:
              groups:
                - "User"

      - name: acquisition_channel
        description: >
          Marketing channel that acquired the customer (snake_case).
          Static attribute captured at registration.
        config:
          meta:
            dimension:
              groups:
                - "User"

      - name: ip_country
        description: >
          Country inferred from customer's IP at signup
          (ISO 3166-1 alpha-2, uppercase).
        config:
          meta:
            dimension:
              label: "Country Code"
              groups:
                - "Geography"

      - name: ip_country_name
        description: >
          Full country name inferred from customer's IP at signup,
          resolved from seed_countries.
        config:
          meta:
            dimension:
              label: "Country"
              groups:
                - "Geography"

      - name: created_at
        description: >
          Timestamp when the customer account was created.
        config:
          meta:
            dimension:
              label: "Signup Date"
              groups:
                - "Dates"

      - name: total_orders
        description: >
          Total number of orders placed by the customer
          (all statuses).
        config:
          meta:
            dimension:
              groups:
                - "Order Counts"
            metrics:
              sum_total_orders:
                type: sum
                label: "Sum of Orders"
                description: >
                  Total orders across all customers.
                groups:
                  - "Orders"
              avg_total_orders:
                type: average
                label: "Avg Orders per Customer"
                description: >
                  Mean orders per customer.
                format: '#,##0.0'
                groups:
                  - "Orders"

      - name: completed_orders
        description: >
          Number of completed orders for the customer.
        config:
          meta:
            dimension:
              groups:
                - "Order Counts"
            metrics:
              sum_completed_orders:
                type: sum
                label: "Sum of Completed Orders"
                description: >
                  Total completed orders across all customers.
                groups:
                  - "Orders"

      - name: refunded_orders
        description: >
          Number of refunded orders for the customer.
        config:
          meta:
            dimension:
              groups:
                - "Order Counts"

      - name: failed_orders
        description: >
          Number of failed orders for the customer.
        config:
          meta:
            dimension:
              groups:
                - "Order Counts"

      - name: total_purchases
        description: >
          Number of successful purchases (completed + refunded)
          for the customer.
        config:
          meta:
            dimension:
              groups:
                - "Order Counts"

      - name: total_revenue_usd
        description: >
          Total revenue from completed orders in USD.
        config:
          meta:
            dimension:
              format: '[$]#,##0.00'
              groups:
                - "Revenue"
            metrics:
              sum_total_revenue_usd:
                type: sum
                label: "Total Revenue (USD)"
                description: >
                  Sum of completed order revenue in USD across
                  customers.
                format: '[$]#,##0.00'
                groups:
                  - "Revenue"
              avg_customer_revenue_usd:
                type: average
                label: "Avg Customer Revenue (USD)"
                description: >
                  Mean revenue per customer in USD.
                format: '[$]#,##0.00'
                groups:
                  - "Revenue"
              median_customer_revenue_usd:
                type: median
                label: "Median Customer Revenue (USD)"
                format: '[$]#,##0.00'
                groups:
                  - "Revenue"
              max_customer_revenue_usd:
                type: max
                label: "Max Customer Revenue (USD)"
                format: '[$]#,##0.00'
                groups:
                  - "Revenue"

      - name: total_refunded_usd
        description: Total refunded amount in USD.
        config:
          meta:
            dimension:
              format: '[$]#,##0.00'
              groups:
                - "Revenue"

      - name: first_order_at
        description: >
          Timestamp of the customer's first order (any status).
        config:
          meta:
            dimension:
              groups:
                - "Dates"

      - name: last_order_at
        description: >
          Timestamp of the customer's most recent order
          (any status).
        config:
          meta:
            dimension:
              groups:
                - "Dates"

      - name: first_purchase_at
        description: >
          Timestamp of the customer's first successful purchase
          (completed or refunded).
        config:
          meta:
            dimension:
              groups:
                - "Dates"

      - name: last_purchase_at
        description: >
          Timestamp of the customer's most recent successful
          purchase (completed or refunded).
        config:
          meta:
            dimension:
              groups:
                - "Dates"

      - name: last_updated_at
        description: >
          Timestamp of the most recent status change across all
          of the customer's orders. Used as the incremental
          watermark.
        config:
          meta:
            dimension:
              hidden: true

      - name: customer_lifetime_days
        description: >
          Days between the customer's first and last order.
          Zero for customers with a single order.
        config:
          meta:
            dimension:
              groups:
                - "Lifecycle"
            metrics:
              avg_customer_lifetime_days:
                type: average
                label: "Avg Customer Lifetime (Days)"
                description: >
                  Mean span between first and last order.
                format: '#,##0.0'
                groups:
                  - "Lifecycle"

      - name: days_since_last_order
        description: >
          Days between today and the customer's most recent order.
          Useful for recency segmentation.
        config:
          meta:
            dimension:
              groups:
                - "Lifecycle"
            metrics:
              avg_days_since_last_order:
                type: average
                label: "Avg Days Since Last Order"
                description: >
                  Mean recency across customers.
                format: '#,##0.0'
                groups:
                  - "Lifecycle"

      - name: is_repeat_purchaser
        description: >
          True if the customer has more than one successful
          purchase (completed or refunded).
        config:
          meta:
            dimension:
              groups:
                - "Lifecycle"
            metrics:
              repeat_purchasers:
                type: sum
                label: "Repeat Purchasers"
                description: >
                  Count of customers with more than one
                  successful purchase.
                groups:
                  - "Customers"


