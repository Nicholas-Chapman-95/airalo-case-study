version: 2

models:
  - name: int_orders_customer_sequenced
    description: >
      Adds customer-level sequencing to deduplicated orders. Contains
      two column namespaces: attempt-level metrics (populated for all
      orders including failed) and purchase-level metrics (populated
      only for completed and refunded orders; null for failed).
    columns:
      - name: order_id
        description: Unique order identifier (UUID, cast to string).
        tests:
          - unique
          - not_null
      - name: user_id
        description: Foreign key to stg_raw__users.
        tests:
          - not_null
      - name: currency
        description: ISO 4217 currency code of the transaction (e.g. USD, EUR).
      - name: card_country
        description: >
          ISO 3166-1 alpha-2 country code of the payment card.
          Null when payment method has no card (e.g. Airmoney).
      - name: destination_country
        description: ISO 3166-1 alpha-2 country code where the eSIM is used.
      - name: payment_method
        description: >
          Normalized payment method in snake_case
          (e.g. credit_card, apple_pay, google_pay, paypal, airmoney).
      - name: status
        description: >
          Latest order status: completed, refunded, or failed.
      - name: esim_package
        description: >
          Original eSIM package label from source
          (e.g. '1GB - 7 Days', 'Unlimited').
      - name: package_data_gb
        description: >
          Data allowance in GB, parsed from esim_package.
          Null for unlimited plans.
      - name: package_validity_days
        description: >
          Plan validity in days, parsed from esim_package.
          Null for unlimited plans.
      - name: is_unlimited_package
        description: True if the eSIM package is an unlimited data plan.
      - name: is_completed
        description: True if the latest order status is 'completed'.
      - name: is_refunded
        description: True if the latest order status is 'refunded'.
      - name: is_failed
        description: True if the latest order status is 'failed'.
      - name: amount
        description: Transaction amount in local currency (numeric, not cents).
      - name: customer_attempt_number
        description: >
          Sequence number of this order among all orders for the
          customer, regardless of status. Ordered by created_at.
      - name: is_first_attempt
        description: >
          True if this is the customer's first order attempt
          (customer_attempt_number = 1).
      - name: customer_purchase_number
        description: >
          Sequence number of this order among completed and refunded
          orders for the customer. Null for failed orders.
      - name: is_first_purchase
        description: >
          True if this is the customer's first successful purchase
          (customer_purchase_number = 1). Null for failed orders.
      - name: previous_purchase_at
        description: >
          Timestamp of the customer's previous successful purchase.
          Null for first purchases and failed orders.
      - name: days_since_previous_purchase
        description: >
          Days between this order and the customer's previous
          successful purchase. Null for first purchases and
          failed orders.
      - name: customer_first_purchase_at
        description: >
          Timestamp of the customer's first successful purchase.
          Null for failed orders.
      - name: days_since_first_purchase
        description: >
          Days between this order and the customer's first successful
          purchase. Zero for first purchases. Null for failed orders.
      - name: created_at
        description: Timestamp when the order was originally created.
      - name: updated_at
        description: Timestamp of the most recent status change.
