version: 2

models:
  - name: stg_raw__orders
    description: >
      Cleaned orders from raw.orders. Contains multiple rows per
      order_id reflecting status changes over time.
    columns:
      - name: order_status_key
        description: >
          Surrogate key hashed from order_id + updated_at.
          Uniquely identifies each status change row.
        tests:
          - unique
          - not_null
      - name: order_id
        description: Unique order identifier (UUID, cast to string).
        tests:
          - not_null
      - name: user_id
        description: >
          Foreign key to stg_raw__users. Null for one known
          source record where Python None was serialized as
          a string (converted to SQL null via nullif).
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('stg_raw__users')
              field: user_id
              config:
                severity: warn
      - name: currency
        description: ISO 4217 currency code of the transaction (e.g. USD, EUR).
      - name: card_country
        description: >
          ISO 3166-1 alpha-2 country code of the payment card.
          Nullable.
      - name: destination_country
        description: ISO 3166-1 alpha-2 country code where the eSIM is used.
      - name: payment_method
        description: >
          Normalized payment method in snake_case
          (e.g. credit_card, apple_pay, google_pay, paypal, airmoney).
      - name: status
        description: >
          Order status: completed, refunded, or failed.
        tests:
          - accepted_values:
              values: ['completed', 'refunded', 'failed']
      - name: esim_package
        description: >
          Original eSIM package label from source
          (e.g. '1GB - 7 Days', 'Unlimited').
      - name: package_data_gigabytes
        description: >
          Data allowance in GB, parsed from esim_package.
          Null for unlimited plans.
      - name: package_validity_days
        description: >
          Plan validity in days, parsed from esim_package.
          Null for unlimited plans.
      - name: is_unlimited_package
        description: True if the eSIM package is an unlimited data plan.
      - name: is_completed
        description: True if the order status is 'completed'.
      - name: is_refunded
        description: True if the order status is 'refunded'.
      - name: is_failed
        description: True if the order status is 'failed'.
      - name: amount
        description: Transaction amount in local currency (numeric, not cents).
      - name: created_at
        description: Timestamp when the order was originally created.
      - name: updated_at
        description: Timestamp of the most recent status change.
