version: 2

unit_tests:

  # -----------------------------------------------------------
  # 2d. customers â€” repeat flags and lifetime derived columns
  # -----------------------------------------------------------
  - name: unit_test_customer_derived_columns
    description: >
      Repeat purchaser flags, lifetime days, and repeat window
      booleans are correct. User1 (3 purchases, days_to_second=30)
      is a repeat purchaser with repeat within 90d and 365d.
      User2 (1 purchase) is not.
    model: customers
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('stg_raw__users')
        rows:
          - {user_id: "300", platform: "ios", acquisition_channel: "organic", ip_country: "US", created_at: "2024-12-01 00:00:00"}
          - {user_id: "301", platform: "android", acquisition_channel: "referral_link", ip_country: "DE", created_at: "2024-12-15 00:00:00"}
      - input: ref('int_orders_aggregated_to_customers')
        rows:
          # user 300: 3 purchases, 30 days to second purchase
          - {user_id: "300", total_orders: 5, completed_orders: 3, refunded_orders: 0, failed_orders: 2, total_purchases: 3, total_revenue_usd: 150, total_refunded_usd: 0, first_order_at: "2025-01-01 00:00:00", last_order_at: "2025-03-01 00:00:00", first_purchase_at: "2025-01-01 00:00:00", last_purchase_at: "2025-03-01 00:00:00", last_order_updated_at: "2025-03-01 00:00:00", days_to_second_purchase: 30}
          # user 301: 1 purchase, no second purchase
          - {user_id: "301", total_orders: 1, completed_orders: 1, refunded_orders: 0, failed_orders: 0, total_purchases: 1, total_revenue_usd: 50, total_refunded_usd: 0, first_order_at: "2025-02-01 00:00:00", last_order_at: "2025-02-01 00:00:00", first_purchase_at: "2025-02-01 00:00:00", last_purchase_at: "2025-02-01 00:00:00", last_order_updated_at: "2025-02-01 00:00:00", days_to_second_purchase: null}
      - input: ref('int_orders_enriched')
        rows:
          - {order_id: "50", user_id: "300", order_updated_at: "2025-01-01 00:00:00"}
          - {order_id: "51", user_id: "301", order_updated_at: "2025-02-01 00:00:00"}
      - input: ref('seed_countries')
        rows:
          - {country_code: "US", country_name: "United States"}
          - {country_code: "DE", country_name: "Germany"}
    expect:
      rows:
        - {user_id: "300", total_orders: 5, customer_lifetime_days: 59, is_repeat_purchaser: true, has_repeat_within_90d: true, has_repeat_within_365d: true}
        - {user_id: "301", total_orders: 1, customer_lifetime_days: 0, is_repeat_purchaser: false, has_repeat_within_90d: false, has_repeat_within_365d: false}
